{% extends 'base/base.html' %}

{% block title %}Notices - School Management System{% endblock %}

{% block content %}
<div class="card">
    <h1 style="margin-bottom: 30px;">School Notices</h1>
    
    <form method="get" class="search-form">
        <input type="text" name="search" placeholder="Search notices..." value="{{ request.GET.search }}">
        <button type="submit" class="btn">Search</button>
        {% if request.GET.search %}
            <a href="{% url 'public:notice_list' %}" class="btn">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Notices loaded via API - replaces direct template data -->
<div id="notices-container">
    <div id="loading-message" class="card">
        <p style="text-align: center; color: #666;">Loading notices...</p>
    </div>
</div>

<div id="pagination-container"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get('search') || '';
    
    // Update search input with current value
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.value = searchTerm;
    }
    
    await loadNotices({ search: searchTerm });
    
    // Simple search form handling - similar to dashboard approach
    const searchForm = document.querySelector('.search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const searchTerm = searchInput.value.trim();
            
            // Update URL and reload notices
            const url = new URL(window.location);
            if (searchTerm) {
                url.searchParams.set('search', searchTerm);
            } else {
                url.searchParams.delete('search');
            }
            window.history.pushState({}, '', url);
            
            loadNotices({ search: searchTerm });
        });
    }
});

async function loadNotices(params = {}) {
    const container = document.getElementById('notices-container');
    
    // Show loading message
    container.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Loading notices...</p></div>';
    
    try {
        const response = await apiClient.getNotices(params);
        const notices = response.results || response;
        
        if (notices && notices.length > 0) {
            container.innerHTML = notices.map(notice => `
                <div class="card">
                    <h2 style="color: #3498db; margin-bottom: 10px;">${escapeHtml(notice.title)}</h2>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        Published on ${new Date(notice.created_at).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric' 
                        })}
                    </p>
                    <div style="line-height: 1.6;">
                        ${escapeHtml(notice.content).replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="card">
                    <p style="text-align: center; color: #666; font-size: 1.1rem;">
                        ${params.search ? `No notices found matching "${escapeHtml(params.search)}".` : 'No notices available at the moment.'}
                    </p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load notices:', error);
        container.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: #e74c3c;">
                    Failed to load notices. Please try again later.
                </p>
                <p style="text-align: center; margin-top: 10px;">
                    <button onclick="loadNotices(${JSON.stringify(params)})" class="btn">Retry</button>
                </p>
            </div>
        `;
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
{% endblock %}