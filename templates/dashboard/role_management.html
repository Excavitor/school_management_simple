{% extends 'base/dashboard_base.html' %}

{% block title %}Role Management - School Management System{% endblock %}

{% block dashboard_content %}
<div class="card">
    <h1 style="margin-bottom: 30px;">Role Management</h1>
    
    <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin-bottom: 30px;">
        <p style="color: #0c5460; margin: 0;">
            <strong>Note:</strong> Only superadmins can manage roles and assign them to users. 
            Roles are based on Django's built-in Group and Permission system.
        </p>
    </div>
    
    {% if user.is_superuser %}
    <div class="actions">
        <a href="{% url 'dashboard:role_create' %}" class="btn btn-success">Create New Role</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">Available Roles (Groups)</h2>
    
    {% if groups %}
    <table class="table">
        <thead>
            <tr>
                <th>Role Name</th>
                <th>Permissions</th>
                <th>Users Count</th>
                {% if user.is_superuser %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for group in groups %}
            <tr>
                <td><strong>{{ group.name }}</strong></td>
                <td>
                    {% if group.permissions.exists %}
                        <div style="max-height: 100px; overflow-y: auto;">
                            {% for permission in group.permissions.all %}
                                <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; margin: 1px; display: inline-block;">
                                    {{ permission.name }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <em style="color: #666;">No permissions assigned</em>
                    {% endif %}
                </td>
                <td>
                    <span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">
                        {{ group.user_set.count }}
                    </span>
                </td>
                {% if user.is_superuser %}
                <td>
                    <div style="display: flex; gap: 5px;">
                        <a href="{% url 'dashboard:role_update' group.pk %}" class="btn" style="padding: 5px 10px; font-size: 0.8rem;">Edit</a>
                        <a href="{% url 'dashboard:role_delete' group.pk %}" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Delete</a>
                    </div>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #666;">
        No roles have been created yet. 
        {% if user.is_superuser %}
            <a href="{% url 'dashboard:role_create' %}">Create the first role</a>.
        {% else %}
            Contact your administrator to create roles.
        {% endif %}
    </p>
    {% endif %}
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">User Role Assignments</h2>
    
    <table class="table">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Current Roles</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <strong>{{ user.first_name }} {{ user.last_name }}</strong>
                    {% if user.is_superuser %}
                        <br><small style="color: #e74c3c; font-weight: bold;">SUPERUSER</small>
                    {% endif %}
                </td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.groups.exists %}
                        {% for group in user.groups.all %}
                            <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem; margin-right: 5px;">
                                {{ group.name }}
                            </span>
                        {% endfor %}
                    {% else %}
                        <em style="color: #666;">No roles assigned</em>
                    {% endif %}
                </td>
                <td>
                    {% if not user.is_superuser or request.user.is_superuser %}
                        <a href="{% url 'dashboard:user_role_update' user.pk %}" class="btn" style="padding: 5px 10px; font-size: 0.8rem;">
                            Manage Roles
                        </a>
                    {% else %}
                        <em style="color: #666; font-size: 0.8rem;">Protected</em>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3 style="margin-bottom: 15px;">Quick Actions</h3>
    <div style="display: flex; gap: 10px;">
        <a href="/admin/auth/group/" class="btn" target="_blank">Manage Groups (Admin)</a>
        <a href="/admin/auth/permission/" class="btn" target="_blank">Manage Permissions (Admin)</a>
    </div>
</div>
{% endblock %}